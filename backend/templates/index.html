<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookSwap SRE Dashboard</title>
    <!-- 1. 載入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. 載入 React 和 ReactDOM (核心) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 3. 載入 Babel (讓瀏覽器看得懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <!-- 這裡開始寫 React 程式碼 -->
    {% raw %}
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 元件: Card ---
        const Card = ({ title, children }) => (
            <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col h-full">
                <div className="text-lg font-semibold text-slate-700 mb-2">{title}</div>
                <div className="flex-1">{children}</div>
            </div>
        );

        // --- 主程式: Dashboard ---
        const Dashboard = () => {
            // 定義狀態 (State)
            const [data, setData] = useState({
                metrics: {
                    availability: 100,
                    errorBudgetUsed: 0,
                    p95Latency: 0,
                    p95Threshold: 200,
                    cpuUsage: 0,
                    cpuThreshold: 90
                },
                logs: [],
                alerts: []
            });

            // 定期向後端撈資料 (Polling)
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch('/api/dashboard-stats');
                        if (!response.ok) {
                             // 如果不是 200 OK (例如在預覽模式下 API 不存在)，不拋出錯誤以免畫面全白，僅 console 紀錄
                             console.warn('API fetch failed (expected in preview mode)');
                             return;
                        }
                        const json = await response.json();
                        setData(json);
                    } catch (error) {
                        console.error("Failed to fetch stats:", error);
                    }
                };

                // 首次執行
                fetchData();
                // 每 2 秒更新一次
                const interval = setInterval(fetchData, 2000);
                return () => clearInterval(interval);
            }, []);

            const { metrics, logs, alerts } = data;

            return (
                <div className="p-6 font-sans text-slate-800 min-h-screen">
                    <header className="mb-8 text-center bg-slate-800 text-white p-4 rounded-lg shadow-md">
                        <h1 className="text-3xl font-bold tracking-tight">BookSwap SRE Dashboard</h1>
                        <p className="text-slate-300 mt-2 text-sm">即時監控與混沌工程驗證 (Live Monitoring & Chaos Validation)</p>
                    </header>

                    <div className="max-w-7xl mx-auto space-y-6">
                        {/* Top Row: KPIs */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Card title="整體可用性 (Availability) - SLO: 99.5%">
                                <div className={`text-5xl font-bold mt-2 ${metrics.availability < 99.5 ? 'text-red-500' : 'text-green-600'}`}>
                                    {metrics.availability}%
                                </div>
                                <div className="text-sm text-slate-400 mt-2">根據請求成功率計算</div>
                            </Card>
                            <Card title="錯誤預算消耗 (Error Budget)">
                                <div className="text-5xl font-bold text-red-500 mt-2">{metrics.errorBudgetUsed}% Used</div>
                                <div className="text-sm text-slate-400 mt-2">模擬數值</div>
                            </Card>
                        </div>

                        {/* Middle Row: Visual Metrics */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {/* Latency */}
                            <Card title={
                                <span className="flex items-center gap-2">
                                    P95 延遲 (Bid Flow)
                                    {metrics.p95Latency > metrics.p95Threshold && <span className="text-red-500 font-bold text-sm bg-red-100 px-2 py-1 rounded">CRITICAL</span>}
                                </span>
                            }>
                                <div className="mt-2">
                                    <div className={`text-3xl font-bold mb-1 ${metrics.p95Latency > metrics.p95Threshold ? 'text-red-500' : 'text-slate-700'}`}>
                                        {metrics.p95Latency} ms
                                    </div>
                                    <div className="text-xs text-slate-400 mb-4">SLO 閾值: {metrics.p95Threshold}ms</div>
                                    <div className="relative h-24 w-full bg-slate-50 rounded-md border border-slate-200 overflow-hidden flex items-center justify-center">
                                        <div
                                            className={`absolute bottom-0 left-0 right-0 opacity-50 transition-all duration-500 ${metrics.p95Latency > metrics.p95Threshold ? 'bg-red-400' : 'bg-green-400'}`}
                                            style={{ height: `${Math.min((metrics.p95Latency / 500) * 100, 100)}%` }}
                                        ></div>
                                        <span className="relative z-10 text-slate-500 font-bold text-xs tracking-widest">REAL-TIME</span>
                                    </div>
                                </div>
                            </Card>

                            {/* Error Rate Pie Chart Simulator */}
                            <Card title="錯誤率分佈 (Error Rate)">
                                <div className="flex flex-col items-center justify-center py-4">
                                    <div className="w-32 h-32 rounded-full relative transition-all duration-500 border-4 border-slate-100 shadow-inner"
                                        style={{
                                            background: `conic-gradient(#ff4d4d 0% ${Math.max(1, metrics.errorBudgetUsed)}%, #4ade80 ${Math.max(1, metrics.errorBudgetUsed)}% 100%)`
                                        }}
                                    ></div>
                                    <div className="flex items-center gap-4 mt-4 text-xs">
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"></span> 5xx Error</div>
                                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-400"></span> Success</div>
                                    </div>
                                </div>
                            </Card>

                            {/* CPU Usage */}
                            <Card title={
                                <span className="flex items-center gap-2">
                                    資源使用率 (CPU)
                                    {metrics.cpuUsage > metrics.cpuThreshold && <span className="text-yellow-500 font-bold text-sm bg-yellow-100 px-2 py-1 rounded">High</span>}
                                </span>
                            }>
                                <div className="mt-2">
                                    <div className="text-3xl font-bold text-slate-700 mb-1">{metrics.cpuUsage}%</div>
                                    <div className="text-xs text-slate-400 mb-6">Critical Threshold: {metrics.cpuThreshold}%</div>
                                    <div className="h-24 w-full bg-slate-100 rounded border border-slate-200 relative overflow-hidden">
                                        <div
                                            className={`absolute bottom-0 left-0 right-0 transition-all duration-500 ${metrics.cpuUsage > 80 ? 'bg-yellow-400' : 'bg-blue-400'}`}
                                            style={{ height: `${metrics.cpuUsage}%` }}
                                        ></div>
                                    </div>
                                </div>
                            </Card>
                        </div>

                        {/* Bottom Row: Logs & Alerts */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Log Viewer */}
                            <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                <h3 className="text-lg font-semibold text-slate-700 mb-4 flex items-center justify-between">
                                    <span>即時日誌 (Live Logs)</span>
                                    <span className="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded">Auto-refreshing</span>
                                </h3>
                                <div className="h-64 overflow-y-auto pr-2 space-y-3 custom-scrollbar flex flex-col">
                                    {logs.length === 0 ? <div className="text-slate-400 text-sm text-center py-10">等待日誌中... (請嘗試發送請求)</div> :
                                     logs.map((log, idx) => (
                                        <div key={idx} className="flex items-start gap-3 p-2 bg-white border border-slate-100 rounded hover:bg-slate-50 transition-colors shadow-sm text-sm">
                                            <span className={`px-2 py-1 text-[10px] font-bold text-white rounded w-14 text-center shrink-0 ${log.type === 'ERROR' ? 'bg-red-500' : log.type === 'WARNING' ? 'bg-yellow-500' : 'bg-blue-500'}`}>
                                                {log.type}
                                            </span>
                                            <span className="text-slate-400 font-mono text-xs shrink-0">[{log.time}]</span>
                                            <div className="text-slate-700 break-all font-mono">
                                                {log.msg}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Alerts */}
                            <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                <h3 className="text-lg font-semibold text-slate-700 mb-4">警報歷史 (Alerts)</h3>
                                <div className="h-64 overflow-y-auto pr-2 space-y-3 custom-scrollbar">
                                    {alerts.length === 0 ?
                                        <div className="flex flex-col items-center justify-center h-full text-green-600 font-medium opacity-80">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mb-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                            System Healthy
                                        </div>
                                    : alerts.map((alert, idx) => (
                                        <div key={idx} className="flex flex-col p-3 bg-white border rounded shadow-sm relative overflow-hidden transition-all animate-pulse">
                                            <div className={`absolute left-0 top-0 bottom-0 w-1 ${alert.level === 'CRITICAL' ? 'bg-red-500' : 'bg-yellow-400'}`}></div>
                                            <div className="pl-3">
                                                <div className={`font-bold text-sm ${alert.level === 'CRITICAL' ? 'text-red-500' : 'text-yellow-500'}`}>
                                                    {alert.level}: {alert.title}
                                                </div>
                                                <div className="text-xs text-slate-400 mt-1">Component: {alert.component}</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
    {% endraw %}
</body>
</html>